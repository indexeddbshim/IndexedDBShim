{"version":3,"file":"indexeddbshim-Key.min.js","sources":["../src/CFG.js","../src/DOMException.js","../src/util.js","../src/cmp.js","../src/Key.js"],"sourcesContent":["/* eslint-disable jsdoc/valid-types -- https://github.com/jsdoc-type-pratt-parser/jsdoc-type-pratt-parser/issues/147 */\n/**\n * @typedef {T[keyof T]} ValueOf<T>\n * @template T\n */\n/* eslint-enable jsdoc/valid-types -- https://github.com/jsdoc-type-pratt-parser/jsdoc-type-pratt-parser/issues/147 */\n\n/**\n * @typedef {{unlink: (path: string, cb: import('fs').NoParamCallback) => void}} FSApi\n */\n\n/**\n * @typedef {{\n *   DEBUG: boolean,\n *   cacheDatabaseInstances: boolean,\n *   autoName: boolean,\n *   fullIDLSupport: boolean,\n *   checkOrigin: boolean,\n *   cursorPreloadPackSize: number,\n *   UnicodeIDStart: string,\n *   UnicodeIDContinue: string,\n *   registerSCA: (\n *     preset: import('typeson').Preset\n *   ) => import('typeson').Preset,\n *   avoidAutoShim: boolean,\n *   win: {\n *     openDatabase: (name: string, version: string, displayName: string, estimatedSize: number) => import('websql-configurable').default\n *   },\n *   DEFAULT_DB_SIZE: number,\n *   useSQLiteIndexes: boolean,\n *   fs: FSApi,\n *   addNonIDBGlobals: boolean,\n *   replaceNonIDBGlobals: boolean,\n *   escapeDatabaseName: (name: string) => string,\n *   unescapeDatabaseName: (name: string) => string,\n *   databaseCharacterEscapeList: string|false,\n *   databaseNameLengthLimit: number|false,\n *   escapeNFDForDatabaseNames: boolean,\n *   addSQLiteExtension: boolean,\n *   memoryDatabase: string,\n *   deleteDatabaseFiles: boolean,\n *   databaseBasePath: string,\n *   sysDatabaseBasePath: string,\n *   sqlBusyTimeout: number,\n *   sqlTrace: () => void,\n *   sqlProfile: () => void,\n *   createIndexes: boolean\n * }} ConfigValues\n */\n\n/**\n * @typedef {ValueOf<ConfigValues>} ConfigValue\n */\n\n/** @type {{[key: string]: ConfigValue}} */\nconst map = {};\n\nconst CFG = /** @type {ConfigValues} */ ({});\n\n/**\n * @typedef {keyof ConfigValues} KeyofConfigValues\n */\n\n/**\n * @typedef {KeyofConfigValues[]} Config\n */\n\n/** @type {Config} */\n([\n    // Boolean for verbose reporting\n    'DEBUG', // Effectively defaults to false (ignored unless `true`)\n\n    // Boolean (effectively defaults to true) on whether to cache WebSQL\n    //  `openDatabase` instances\n    'cacheDatabaseInstances',\n\n    // Boolean on whether to auto-name databases (based on an\n    //   auto-increment) when the empty string is supplied; useful with\n    //   `memoryDatabase`; defaults to `false` which means the empty string\n    //   will be used as the (valid) database name\n    'autoName',\n\n    // Determines whether the slow-performing `Object.setPrototypeOf`\n    //    calls required for full WebIDL compliance will be used. Probably\n    //    only needed for testing or environments where full introspection\n    //    on class relationships is required; see\n    //    http://stackoverflow.com/questions/41927589/rationales-consequences-of-webidl-class-inheritance-requirements\n    'fullIDLSupport', // Effectively defaults to false (ignored unless `true`)\n\n    // Boolean on whether to perform origin checks in `IDBFactory` methods\n    // Effectively defaults to `true` (must be set to `false` to cancel checks)\n    'checkOrigin',\n\n    // Used by `IDBCursor` continue methods for number of records to cache;\n    //  Defaults to 100\n    'cursorPreloadPackSize',\n\n    // See optional API (`shimIndexedDB.__setUnicodeIdentifiers`);\n    //    or just use the Unicode builds which invoke this method\n    //    automatically using the large, fully spec-compliant, regular\n    //    expression strings of `src/UnicodeIdentifiers.js`)\n    // In the non-Unicode builds, defaults to /[$A-Z_a-z]/\n    'UnicodeIDStart',\n    // In the non-Unicode builds, defaults to /[$0-9A-Z_a-z]/\n    'UnicodeIDContinue',\n\n    // Used by SCA.js for optional restructuring of typeson-registry\n    //   Structured Cloning Algorithm; should only be needed for ensuring data\n    //   created in 3.* versions of IndexedDBShim continue to work; see the\n    //   library `typeson-registry-sca-reverter` to get a function to do this\n    'registerSCA',\n\n    // BROWSER-SPECIFIC CONFIG\n    'avoidAutoShim', // Where WebSQL is detected but where `indexedDB` is\n    //    missing or poor support is known (non-Chrome Android or\n    //    non-Safari iOS9), the shim will be auto-applied without\n    //   `shimIndexedDB.__useShim()`. Set this to `true` to avoid forcing\n    //    the shim for such cases.\n\n    // -----------SQL CONFIG----------\n    // Object (`window` in the browser) on which there may be an\n    //  `openDatabase` method (if any) for WebSQL. (The browser\n    //  throws if attempting to call `openDatabase` without the window\n    //  so this is why the config doesn't just allow the function.)\n    // Defaults to `window` or `self` in browser builds or\n    //  a singleton object with the `openDatabase` method set to\n    //  the \"websql\" package in Node.\n    'win',\n\n    // For internal `openDatabase` calls made by `IDBFactory` methods;\n    //  per the WebSQL spec, \"User agents are expected to use the display name\n    //  and the estimated database size to optimize the user experience.\n    //  For example, a user agent could use the estimated size to suggest an\n    //  initial quota to the user. This allows a site that is aware that it\n    //  will try to use hundreds of megabytes to declare this upfront, instead\n    //  of the user agent prompting the user for permission to increase the\n    //  quota every five megabytes.\"\n    // Defaults to (4 * 1024 * 1024) or (25 * 1024 * 1024) in Safari\n    'DEFAULT_DB_SIZE',\n    // Whether to create indexes on SQLite tables (and also whether to try\n    //   dropping)\n    // Effectively defaults to `false` (ignored unless `true`)\n    'useSQLiteIndexes',\n\n    // NODE-IMPINGING SETTINGS (created for sake of limitations in Node\n    //    or desktop file system implementation but applied by default in\n    //    browser for parity)\n\n    // File system module with `unlink` to remove deleted database files\n    'fs',\n\n    // Used when setting global shims to determine whether to try to add\n    //   other globals shimmed by the library (`ShimDOMException`,\n    //   `ShimDOMStringList`, `ShimEvent`, `ShimCustomEvent`, `ShimEventTarget`)\n    // Effectively defaults to `false` (ignored unless `true`)\n    'addNonIDBGlobals',\n    // Used when setting global shims to determine whether to try to overwrite\n    //   other globals shimmed by the library (`DOMException`, `DOMStringList`,\n    //   `Event`, `CustomEvent`, `EventTarget`)\n    // Effectively defaults to `false` (ignored unless `true`)\n    'replaceNonIDBGlobals',\n\n    // Overcoming limitations with node-sqlite3/storing database name on\n    //   file systems\n    // https://en.wikipedia.org/wiki/Filename#Reserved_characters_and_words\n    // Defaults to prefixing database with `D_`, escaping\n    //   `databaseCharacterEscapeList`, escaping NUL, and\n    //   escaping upper case letters, as well as enforcing\n    //   `databaseNameLengthLimit`\n    'escapeDatabaseName',\n    // Not used internally; usable as a convenience method\n    'unescapeDatabaseName',\n\n    // Defaults to global regex representing the following\n    //   (characters nevertheless commonly reserved in modern,\n    //   Unicode-supporting systems): 0x00-0x1F 0x7F \" * / : < > ? \\ |\n    'databaseCharacterEscapeList',\n    // Defaults to 254 (shortest typical modern file length limit)\n    'databaseNameLengthLimit',\n\n    // Boolean defaulting to true on whether to escape NFD-escaping\n    //   characters to avoid clashes on MacOS which performs NFD on files\n    'escapeNFDForDatabaseNames',\n\n    // Boolean on whether to add the `.sqlite` extension to file names;\n    //   defaults to `true`\n    'addSQLiteExtension',\n    // Various types of in-memory databases that can auto-delete\n    [\n        'memoryDatabase',\n        /**\n         * @param {string} val\n         * @throws {TypeError}\n         * @returns {void}\n         */\n        (val) => {\n            if (!(/^(?::memory:|file::memory:(\\?[^#]*)?(#.*)?)?$/u).test(\n                /** @type {string} */ (val)\n            )) {\n                throw new TypeError(\n                    '`memoryDatabase` must be the empty string, \":memory:\", or a ' +\n                    '\"file::memory:[?queryString][#hash] URL\".'\n                );\n            }\n        }\n    ],\n\n    // NODE-SPECIFIC CONFIG\n    // Boolean on whether to delete the database file itself after\n    //   `deleteDatabase`; defaults to `true` as the database will be empty\n    'deleteDatabaseFiles',\n    'databaseBasePath',\n    'sysDatabaseBasePath',\n\n    // NODE-SPECIFIC WEBSQL CONFIG\n    'sqlBusyTimeout', // Defaults to 1000\n    'sqlTrace', // Callback not used by default\n    'sqlProfile', // Callback not used by default\n\n    'createIndexes'\n]).forEach((prop) => {\n    /** @type {(val: any) => void} */\n    let validator;\n    if (Array.isArray(prop)) {\n        [prop, validator] = prop;\n    }\n    Object.defineProperty(CFG, prop, {\n        get () {\n            return map[prop];\n        },\n        set (val) {\n            if (validator) {\n                validator(val);\n            }\n            map[prop] = val;\n        }\n    });\n});\n\nexport default CFG;\n","import CFG from './CFG.js';\n\n/**\n * Creates a native DOMException, for browsers that support it.\n * @param {string} name\n * @param {string} message\n * @returns {DOMException}\n */\nfunction createNativeDOMException (name, message) {\n    // @ts-expect-error It's ok\n    return new DOMException.prototype.constructor(\n        message,\n        name || 'DOMException'\n    );\n}\n\n// From web-platform-tests testharness.js name_code_map (though not in new spec)\n\n/**\n * @typedef {\"IndexSizeError\"|\"HierarchyRequestError\"|\"WrongDocumentError\"|\n * \"InvalidCharacterError\"|\"NoModificationAllowedError\"|\"NotFoundError\"|\n * \"NotSupportedError\"|\"InUseAttributeError\"|\"InvalidStateError\"|\n * \"SyntaxError\"|\"InvalidModificationError\"|\"NamespaceError\"|\n * \"InvalidAccessError\"|\"TypeMismatchError\"|\"SecurityError\"|\n * \"NetworkError\"|\"AbortError\"|\"URLMismatchError\"|\"QuotaExceededError\"|\n * \"TimeoutError\"|\"InvalidNodeTypeError\"|\"DataCloneError\"|\"EncodingError\"|\n * \"NotReadableError\"|\"UnknownError\"|\"ConstraintError\"|\"DataError\"|\n * \"TransactionInactiveError\"|\"ReadOnlyError\"|\"VersionError\"|\n * \"OperationError\"|\"NotAllowedError\"} Code\n */\n\nconst codes = {\n    IndexSizeError: 1,\n    HierarchyRequestError: 3,\n    WrongDocumentError: 4,\n    InvalidCharacterError: 5,\n    NoModificationAllowedError: 7,\n    NotFoundError: 8,\n    NotSupportedError: 9,\n    InUseAttributeError: 10,\n    InvalidStateError: 11,\n    SyntaxError: 12,\n    InvalidModificationError: 13,\n    NamespaceError: 14,\n    InvalidAccessError: 15,\n    TypeMismatchError: 17,\n    SecurityError: 18,\n    NetworkError: 19,\n    AbortError: 20,\n    URLMismatchError: 21,\n    QuotaExceededError: 22,\n    TimeoutError: 23,\n    InvalidNodeTypeError: 24,\n    DataCloneError: 25,\n\n    EncodingError: 0,\n    NotReadableError: 0,\n    UnknownError: 0,\n    ConstraintError: 0,\n    DataError: 0,\n    TransactionInactiveError: 0,\n    ReadOnlyError: 0,\n    VersionError: 0,\n    OperationError: 0,\n    NotAllowedError: 0\n};\n\n/**\n * @typedef {\"INDEX_SIZE_ERR\"|\"DOMSTRING_SIZE_ERR\"|\"HIERARCHY_REQUEST_ERR\"|\n * \"WRONG_DOCUMENT_ERR\"|\"INVALID_CHARACTER_ERR\"|\"NO_DATA_ALLOWED_ERR\"|\n * \"NO_MODIFICATION_ALLOWED_ERR\"|\"NOT_FOUND_ERR\"|\"NOT_SUPPORTED_ERR\"|\n * \"INUSE_ATTRIBUTE_ERR\"|\"INVALID_STATE_ERR\"|\"SYNTAX_ERR\"|\n * \"INVALID_MODIFICATION_ERR\"|\"NAMESPACE_ERR\"|\"INVALID_ACCESS_ERR\"|\n * \"VALIDATION_ERR\"|\"TYPE_MISMATCH_ERR\"|\"SECURITY_ERR\"|\"NETWORK_ERR\"|\n * \"ABORT_ERR\"|\"URL_MISMATCH_ERR\"|\"QUOTA_EXCEEDED_ERR\"|\"TIMEOUT_ERR\"|\n * \"INVALID_NODE_TYPE_ERR\"|\"DATA_CLONE_ERR\"} LegacyCode\n */\n\nconst legacyCodes = {\n    INDEX_SIZE_ERR: 1,\n    DOMSTRING_SIZE_ERR: 2,\n    HIERARCHY_REQUEST_ERR: 3,\n    WRONG_DOCUMENT_ERR: 4,\n    INVALID_CHARACTER_ERR: 5,\n    NO_DATA_ALLOWED_ERR: 6,\n    NO_MODIFICATION_ALLOWED_ERR: 7,\n    NOT_FOUND_ERR: 8,\n    NOT_SUPPORTED_ERR: 9,\n    INUSE_ATTRIBUTE_ERR: 10,\n    INVALID_STATE_ERR: 11,\n    SYNTAX_ERR: 12,\n    INVALID_MODIFICATION_ERR: 13,\n    NAMESPACE_ERR: 14,\n    INVALID_ACCESS_ERR: 15,\n    VALIDATION_ERR: 16,\n    TYPE_MISMATCH_ERR: 17,\n    SECURITY_ERR: 18,\n    NETWORK_ERR: 19,\n    ABORT_ERR: 20,\n    URL_MISMATCH_ERR: 21,\n    QUOTA_EXCEEDED_ERR: 22,\n    TIMEOUT_ERR: 23,\n    INVALID_NODE_TYPE_ERR: 24,\n    DATA_CLONE_ERR: 25\n};\n\n/**\n *\n * @returns {typeof DOMException}\n */\nfunction createNonNativeDOMExceptionClass () {\n    /**\n     * @param {string|undefined} message\n     * @param {Code|LegacyCode} name\n     * @returns {void}\n     */\n    function DOMException (message, name) {\n        // const err = Error.prototype.constructor.call(this, message); // Any use to this? Won't set this.message\n        this[Symbol.toStringTag] = 'DOMException';\n        this._code = name in codes\n            ? codes[/** @type {Code} */ (name)]\n            : (legacyCodes[/** @type {LegacyCode} */ (name)] || 0);\n        this._name = name || 'Error';\n        // We avoid `String()` in this next line as it converts Symbols\n        this._message = message === undefined ? '' : ('' + message); // eslint-disable-line no-implicit-coercion -- Don't convert symbols\n        Object.defineProperty(this, 'code', {\n            configurable: true,\n            enumerable: true,\n            writable: true,\n            value: this._code\n        });\n        if (name !== undefined) {\n            Object.defineProperty(this, 'name', {\n                configurable: true,\n                enumerable: true,\n                writable: true,\n                value: this._name\n            });\n        }\n        if (message !== undefined) {\n            Object.defineProperty(this, 'message', {\n                configurable: true,\n                enumerable: false,\n                writable: true,\n                value: this._message\n            });\n        }\n    }\n\n    // Necessary for W3C tests which complains if `DOMException` has properties on its \"own\" prototype\n\n    // class DummyDOMException extends Error {}; // Sometimes causing problems in Node\n    /* eslint-disable func-name-matching -- See above */\n    /**\n     * @class\n     */\n    const DummyDOMException = function DOMException () { /* */ };\n    /* eslint-enable func-name-matching -- See above */\n    DummyDOMException.prototype = Object.create(Error.prototype); // Intended for subclassing\n    /** @type {const} */ (['name', 'message']).forEach((prop) => {\n        Object.defineProperty(DummyDOMException.prototype, prop, {\n            enumerable: true,\n            /**\n             * @this {DOMException}\n             * @returns {string}\n             */\n            get () {\n                if (!(this instanceof DOMException ||\n                    // @ts-expect-error Just checking\n                    this instanceof DummyDOMException ||\n                    // @ts-expect-error Just checking\n                    this instanceof Error)) {\n                    throw new TypeError('Illegal invocation');\n                }\n                return this[prop === 'name' ? '_name' : '_message'];\n            }\n        });\n    });\n    // DOMException uses the same `toString` as `Error`\n    Object.defineProperty(DummyDOMException.prototype, 'code', {\n        configurable: true,\n        enumerable: true,\n        get () {\n            throw new TypeError('Illegal invocation');\n        }\n    });\n    // @ts-expect-error It's ok\n    DOMException.prototype = new DummyDOMException();\n\n    DOMException.prototype[Symbol.toStringTag] = 'DOMExceptionPrototype';\n    Object.defineProperty(DOMException, 'prototype', {\n        writable: false\n    });\n\n    const keys = Object.keys(codes);\n\n    /** @type {(keyof codes)[]} */ (keys).forEach(\n        (codeName) => {\n            Object.defineProperty(DOMException.prototype, codeName, {\n                enumerable: true,\n                configurable: false,\n                value: codes[codeName]\n            });\n            Object.defineProperty(DOMException, codeName, {\n                enumerable: true,\n                configurable: false,\n                value: codes[codeName]\n            });\n        }\n    );\n    /** @type {(keyof legacyCodes)[]} */ (Object.keys(legacyCodes)).forEach((\n        codeName\n    ) => {\n        Object.defineProperty(DOMException.prototype, codeName, {\n            enumerable: true,\n            configurable: false,\n            value: legacyCodes[codeName]\n        });\n        Object.defineProperty(DOMException, codeName, {\n            enumerable: true,\n            configurable: false,\n            value: legacyCodes[codeName]\n        });\n    });\n    Object.defineProperty(DOMException.prototype, 'constructor', {\n        writable: true,\n        configurable: true,\n        enumerable: false,\n        value: DOMException\n    });\n\n    // @ts-expect-error We don't need all its properties\n    return DOMException;\n}\n\nconst ShimNonNativeDOMException = createNonNativeDOMExceptionClass();\n\n/**\n * Creates a generic Error object.\n * @param {string} name\n * @param {string} message\n * @returns {Error}\n */\nfunction createNonNativeDOMException (name, message) {\n    return new ShimNonNativeDOMException(message, name);\n}\n\n/**\n * @typedef {{\n *   message: string|DOMString\n * }} ErrorLike\n */\n\n/**\n * Logs detailed error information to the console.\n * @param {string} name\n * @param {string} message\n * @param {string|ErrorLike|boolean|null} [error]\n * @returns {void}\n */\nfunction logError (name, message, error) {\n    if (CFG.DEBUG) {\n        const msg = error && typeof error === 'object' && error.message\n            ? error.message\n            : /** @type {string} */ (error);\n\n        const method = typeof (console.error) === 'function' ? 'error' : 'log';\n        console[method](name + ': ' + message + '. ' + (msg || ''));\n        if (console.trace) { console.trace(); }\n    }\n}\n\n/**\n * @typedef {any} ArbitraryValue\n */\n\n/**\n * @param {ArbitraryValue} obj\n * @returns {boolean}\n */\nfunction isErrorOrDOMErrorOrDOMException (obj) {\n    return obj && typeof obj === 'object' && // We don't use util.isObj here as mutual dependency causing problems in Babel with browser\n        typeof obj.name === 'string';\n}\n\n/**\n * Finds the error argument.  This is useful because some WebSQL callbacks\n * pass the error as the first argument, and some pass it as the second\n * argument.\n * @param {(Error|{message?: string, name?: string}|any)[]} args\n * @returns {Error|DOMException|undefined}\n */\nfunction findError (args) {\n    let err;\n    if (args) {\n        if (args.length === 1) {\n            return args[0];\n        }\n        for (const arg of args) {\n            if (isErrorOrDOMErrorOrDOMException(arg)) {\n                return arg;\n            }\n            if (arg && typeof arg.message === 'string') {\n                err = arg;\n            }\n        }\n    }\n    return err;\n}\n\n/**\n *\n * @param {SQLError} webSQLErr\n * @returns {(DOMException|Error) & {\n *   sqlError: SQLError\n * }}\n */\nfunction webSQLErrback (webSQLErr) {\n    let name, message;\n    switch (webSQLErr.code) {\n    case 4: { // SQLError.QUOTA_ERR\n        name = 'QuotaExceededError';\n        message = 'The operation failed because there was not enough ' +\n            'remaining storage space, or the storage quota was reached ' +\n            'and the user declined to give more space to the database.';\n        break;\n    }\n    /*\n    // Should a WebSQL timeout treat as IndexedDB `TransactionInactiveError` or `UnknownError`?\n    case 7: { // SQLError.TIMEOUT_ERR\n        // All transaction errors abort later, so no need to mark inactive\n        name = 'TransactionInactiveError';\n        message = 'A request was placed against a transaction which is currently not active, or which is finished (Internal SQL Timeout).';\n        break;\n    }\n    */\n    default: {\n        name = 'UnknownError';\n        message = 'The operation failed for reasons unrelated to the database itself and not covered by any other errors.';\n        break;\n    }\n    }\n    message += ' (' + webSQLErr.message + ')--(' + webSQLErr.code + ')';\n    const err =\n        /**\n         * @type {(Error | DOMException) & {\n         *   sqlError: SQLError\n         * }}\n         */\n        (createDOMException(name, message));\n    err.sqlError = webSQLErr;\n    return err;\n}\n\nlet test, useNativeDOMException = false;\n\n// Test whether we can use the browser's native DOMException class\ntry {\n    test = createNativeDOMException('test name', 'test message');\n    if (isErrorOrDOMErrorOrDOMException(test) && test.name === 'test name' && test.message === 'test message') {\n        // Native DOMException works as expected\n        useNativeDOMException = true;\n    }\n} catch (err) {}\n\nconst createDOMException = useNativeDOMException\n    // eslint-disable-next-line @stylistic/operator-linebreak -- Need JSDoc\n    ? /**\n     * @param {string} name\n     * @param {string} message\n     * @param {ErrorLike} [error]\n     * @returns {DOMException}\n     */\n    function (name, message, error) {\n        logError(name, message, error);\n        return createNativeDOMException(name, message);\n    }\n    // eslint-disable-next-line @stylistic/operator-linebreak -- Need JSDoc\n    : /**\n    * @param {string} name\n    * @param {string} message\n    * @param {ErrorLike} [error]\n    * @returns {Error}\n    */\n    function (name, message, error) {\n        logError(name, message, error);\n        return createNonNativeDOMException(name, message);\n    };\n\nconst ShimDOMException = useNativeDOMException\n    ? DOMException\n    : ShimNonNativeDOMException;\n\nexport {logError, findError, ShimDOMException, createDOMException, webSQLErrback};\n","/* eslint-disable new-cap -- ToString is how it is defined */\n/* eslint-disable sonarjs/no-control-regex -- Needed */\nimport CFG from './CFG.js';\nimport expandsOnNFD from './unicode-regex.js';\n\n/**\n * @typedef {number} Integer\n */\n\n/**\n * @param {string} arg\n * @returns {string}\n */\nfunction escapeUnmatchedSurrogates (arg) {\n    // http://stackoverflow.com/a/6701665/271577\n    return arg.replaceAll(\n        /([\\uD800-\\uDBFF])(?![\\uDC00-\\uDFFF])|(^|[^\\uD800-\\uDBFF])([\\uDC00-\\uDFFF])/gu,\n        function (_, unmatchedHighSurrogate, precedingLow, unmatchedLowSurrogate) {\n            // Could add a corresponding surrogate for compatibility with `node-sqlite3`: http://bugs.python.org/issue12569 and http://stackoverflow.com/a/6701665/271577\n            //   but Chrome having problems\n            if (unmatchedHighSurrogate) {\n                return '^2' + unmatchedHighSurrogate.codePointAt()\n                    .toString(16).padStart(4, '0');\n            }\n            return (precedingLow || '') + '^3' +\n                unmatchedLowSurrogate.codePointAt().toString(16).padStart(4, '0');\n        }\n    );\n}\n\n/**\n * @param {string} arg\n * @returns {string}\n */\nfunction escapeNameForSQLiteIdentifier (arg) {\n    // http://stackoverflow.com/a/6701665/271577\n    return '_' + // Prevent empty string\n        escapeUnmatchedSurrogates(\n            arg.replaceAll('^', '^^') // Escape our escape\n                // http://www.sqlite.org/src/tktview?name=57c971fc74\n                .replaceAll('\\0', '^0')\n                // We need to avoid identifiers being treated as duplicates based on SQLite's ASCII-only case-insensitive table and column names\n                // (For SQL in general, however, see http://stackoverflow.com/a/17215009/271577\n                // See also https://www.sqlite.org/faq.html#q18 re: Unicode (non-ASCII) case-insensitive not working\n                .replaceAll(/([A-Z])/gu, '^$1')\n        );\n}\n\n/**\n * The escaping of unmatched surrogates was needed by Chrome but not Node.\n * @param {string} arg\n * @returns {string}\n */\nfunction escapeSQLiteStatement (arg) {\n    return escapeUnmatchedSurrogates(arg.replaceAll('^', '^^').replaceAll('\\0', '^0'));\n}\n\n/**\n * @param {string} arg\n * @returns {string}\n */\nfunction unescapeSQLiteResponse (arg) {\n    return unescapeUnmatchedSurrogates(arg)\n        .replaceAll(/(\\^+)0/gu, (_, esc) => {\n            return esc.length % 2\n                ? esc.slice(1) + '\\0'\n                : _;\n        })\n        .replaceAll('^^', '^');\n}\n\n/**\n * @param {string} arg\n * @returns {string}\n */\nfunction sqlEscape (arg) {\n    // https://www.sqlite.org/lang_keywords.html\n    // http://stackoverflow.com/a/6701665/271577\n    // There is no need to escape ', `, or [], as\n    //   we should always be within double quotes\n    // NUL should have already been stripped\n    return arg.replaceAll('\"', '\"\"');\n}\n\n/**\n * @param {string} arg\n * @returns {string}\n */\nfunction sqlQuote (arg) {\n    return '\"' + sqlEscape(arg) + '\"';\n}\n\n/**\n * @param {string} db\n * @throws {Error}\n * @returns {string}\n */\nfunction escapeDatabaseNameForSQLAndFiles (db) {\n    if (CFG.escapeDatabaseName) {\n        // We at least ensure NUL is escaped by default, but we need to still\n        //   handle empty string and possibly also length (potentially\n        //   throwing if too long), escaping casing (including Unicode?),\n        //   and escaping special characters depending on file system\n        return CFG.escapeDatabaseName(escapeSQLiteStatement(db));\n    }\n    db = 'D' + escapeNameForSQLiteIdentifier(db);\n    if (CFG.escapeNFDForDatabaseNames !== false) {\n        // ES6 copying of regex with different flags\n        db = db.replaceAll(new RegExp(expandsOnNFD, 'gu'), function (expandable) {\n            return '^4' + /** @type {Integer} */ (expandable.codePointAt(0)).toString(16).padStart(6, '0');\n        });\n    }\n    if (CFG.databaseCharacterEscapeList !== false) {\n        db = db.replace(\n            (CFG.databaseCharacterEscapeList\n                ? new RegExp(CFG.databaseCharacterEscapeList, 'gu')\n                : /[\\u0000-\\u001F\\u007F\"*/:<>?\\\\|]/gu), // eslint-disable-line no-control-regex -- Controls needed\n            function (n0) {\n                // eslint-disable-next-line unicorn/prefer-code-point -- Switch to `codePointAt`?\n                return '^1' + n0.charCodeAt(0).toString(16).padStart(2, '0');\n            }\n        );\n    }\n    if (CFG.databaseNameLengthLimit !== false &&\n        db.length >= ((CFG.databaseNameLengthLimit || 254) - (CFG.addSQLiteExtension !== false ? 7 /* '.sqlite'.length */ : 0))) {\n        throw new Error(\n            'Unexpectedly long database name supplied; length limit required for Node compatibility; passed length: ' +\n            db.length + '; length limit setting: ' + (CFG.databaseNameLengthLimit || 254) + '.'\n        );\n    }\n    return db + (CFG.addSQLiteExtension !== false ? '.sqlite' : ''); // Shouldn't have quoting (do we even need NUL/case escaping here?)\n}\n\n/**\n * @param {string} arg\n * @returns {string}\n */\nfunction unescapeUnmatchedSurrogates (arg) {\n    return arg\n        .replaceAll(/(\\^+)3(d[0-9a-f]{3})/gu, (_, esc, lowSurr) => {\n            return esc.length % 2\n                ? esc.slice(1) + String.fromCodePoint(Number.parseInt(lowSurr, 16))\n                : _;\n        }).replaceAll(/(\\^+)2(d[0-9a-f]{3})/gu, (_, esc, highSurr) => {\n            return esc.length % 2\n                ? esc.slice(1) + String.fromCodePoint(Number.parseInt(highSurr, 16))\n                : _;\n        });\n}\n\n/**\n * Not in use internally but supplied for convenience.\n * @param {string} db\n * @returns {string}\n */\nfunction unescapeDatabaseNameForSQLAndFiles (db) {\n    if (CFG.unescapeDatabaseName) {\n        // We at least ensure NUL is unescaped by default, but we need to still\n        //   handle empty string and possibly also length (potentially\n        //   throwing if too long), unescaping casing (including Unicode?),\n        //   and unescaping special characters depending on file system\n        return CFG.unescapeDatabaseName(unescapeSQLiteResponse(db));\n    }\n\n    return unescapeUnmatchedSurrogates(\n        db.slice(2) // D_\n            // CFG.databaseCharacterEscapeList\n            .replaceAll(/(\\^+)1([0-9a-f]{2})/gu, (_, esc, hex) => {\n                return esc.length % 2\n                    ? esc.slice(1) + String.fromCodePoint(Number.parseInt(hex, 16))\n                    : _;\n            // CFG.escapeNFDForDatabaseNames\n            }).replaceAll(/(\\^+)4([0-9a-f]{6})/gu, (_, esc, hex) => {\n                return esc.length % 2\n                    ? esc.slice(1) + String.fromCodePoint(Number.parseInt(hex, 16))\n                    : _;\n            })\n    // escapeNameForSQLiteIdentifier (including unescapeUnmatchedSurrogates() above)\n    ).replaceAll(/(\\^+)([A-Z])/gu, (_, esc, upperCase) => {\n        return esc.length % 2\n            ? esc.slice(1) + upperCase\n            : _;\n    }).replaceAll(/(\\^+)0/gu, (_, esc) => {\n        return esc.length % 2\n            ? esc.slice(1) + '\\0'\n            : _;\n    }).replaceAll('^^', '^');\n}\n\n/**\n * @param {string} store\n * @returns {string}\n */\nfunction escapeStoreNameForSQL (store) {\n    return sqlQuote('S' + escapeNameForSQLiteIdentifier(store));\n}\n\n/**\n * @param {string} index\n * @returns {string}\n */\nfunction escapeIndexNameForSQL (index) {\n    return sqlQuote('I' + escapeNameForSQLiteIdentifier(index));\n}\n\n/**\n * @param {string} index\n * @returns {string}\n */\nfunction escapeIndexNameForSQLKeyColumn (index) {\n    return 'I' + escapeNameForSQLiteIdentifier(index);\n}\n\n/**\n * @todo Didn't need to escape `%`. Do we still need this escape?\n * @param {string} str\n * @returns {string}\n */\nfunction sqlLIKEEscape (str) {\n    // https://www.sqlite.org/lang_expr.html#like\n    return str.replaceAll('^', '^^');\n}\n\n/**\n * @typedef {Function} AnyClass\n */\n\n// Babel doesn't seem to provide a means of using the `instanceof` operator with Symbol.hasInstance (yet?)\n/**\n *\n * @param {AnyValue} obj\n * @param {AnyClass} Clss\n * @returns {boolean}\n */\nfunction instanceOf (obj, Clss) {\n    return Clss[Symbol.hasInstance](obj);\n}\n\n/**\n *\n * @param {AnyValue} obj\n * @returns {obj is object}\n */\nfunction isObj (obj) {\n    return obj !== null && typeof obj === 'object';\n}\n\n/**\n *\n * @param {object} obj\n * @returns {boolean}\n */\nfunction isDate (obj) {\n    return isObj(obj) && 'getDate' in obj && typeof obj.getDate === 'function';\n}\n\n/**\n *\n * @param {object} obj\n * @returns {boolean}\n */\nfunction isBlob (obj) {\n    return isObj(obj) && 'size' in obj && typeof obj.size === 'number' &&\n    'slice' in obj && typeof obj.slice === 'function' && !('lastModified' in obj);\n}\n\n/**\n *\n * @param {object} obj\n * @returns {boolean}\n */\nfunction isRegExp (obj) {\n    return isObj(obj) && 'flags' in obj && typeof obj.flags === 'string' &&\n    'exec' in obj && typeof obj.exec === 'function';\n}\n\n/**\n *\n * @param {object} obj\n * @returns {boolean}\n */\nfunction isFile (obj) {\n    return isObj(obj) && 'name' in obj && typeof obj.name === 'string' &&\n    'slice' in obj && typeof obj.slice === 'function' && 'lastModified' in obj;\n}\n\n/**\n *\n * @param {AnyValue} obj\n * @returns {boolean}\n */\nfunction isBinary (obj) {\n    return isObj(obj) && 'byteLength' in obj && typeof obj.byteLength === 'number' && (\n        ('slice' in obj && typeof obj.slice === 'function') || // `TypedArray` (view on buffer) or `ArrayBuffer`\n        ('getFloat64' in obj && typeof obj.getFloat64 === 'function') // `DataView` (view on buffer)\n    );\n}\n\n/**\n *\n * @param {AnyValue} obj\n * @returns {boolean}\n */\nfunction isIterable (obj) {\n    return isObj(obj) && Symbol.iterator in obj &&\n        typeof obj[Symbol.iterator] === 'function';\n}\n\n/**\n *\n * @param {object} obj\n * @param {string[]} props\n * @returns {void}\n */\nfunction defineOuterInterface (obj, props) {\n    props.forEach((prop) => {\n        const o = {\n            get [prop] () {\n                throw new TypeError('Illegal invocation');\n            },\n            // @ts-expect-error Deliberately errs\n            set [prop] (val) {\n                throw new TypeError('Illegal invocation');\n            }\n        };\n        const desc = /** @type {PropertyDescriptor} */ (\n            Object.getOwnPropertyDescriptor(o, prop)\n        );\n        Object.defineProperty(obj, prop, desc);\n    });\n}\n\n/**\n *\n * @param {object} obj\n * @param {string[]} props\n * @returns {void}\n */\nfunction defineReadonlyOuterInterface (obj, props) {\n    props.forEach((prop) => {\n        const o = {\n            get [prop] () {\n                throw new TypeError('Illegal invocation');\n            }\n        };\n        const desc = /** @type {PropertyDescriptor} */ (\n            Object.getOwnPropertyDescriptor(o, prop)\n        );\n        Object.defineProperty(obj, prop, desc);\n    });\n}\n\n/**\n *\n * @param {object & {\n *   [key: string]: any\n * }} obj\n * @param {string[]} listeners\n * @returns {void}\n */\nfunction defineListenerProperties (obj, listeners) {\n    listeners = typeof listeners === 'string' ? [listeners] : listeners;\n    listeners.forEach((listener) => {\n        const o = {\n            get [listener] () {\n                return obj['__' + listener];\n            },\n            /**\n             * @param {AnyValue} val\n             * @returns {void}\n             */\n            set [listener] (val) {\n                obj['__' + listener] = val;\n            }\n        };\n        const desc = /** @type {PropertyDescriptor} */ (\n            Object.getOwnPropertyDescriptor(o, listener)\n        );\n        // desc.enumerable = true; // Default\n        // desc.configurable = true; // Default // Needed by support.js in W3C IndexedDB tests (for openListeners)\n        Object.defineProperty(obj, listener, desc);\n    });\n    listeners.forEach((l) => {\n        obj[l] = null;\n    });\n}\n\n/**\n *\n * @param {object} obj\n * @param {string|string[]} props\n * @param {null|{\n *   [key: string]: any\n * }} getter\n * @returns {void}\n */\nfunction defineReadonlyProperties (obj, props, getter = null) {\n    props = typeof props === 'string' ? [props] : props;\n    props.forEach(function (prop) {\n        let o;\n        if (getter && prop in getter) {\n            o = getter[prop];\n        } else {\n            Object.defineProperty(obj, '__' + prop, {\n                enumerable: false,\n                configurable: false,\n                writable: true\n            });\n            // We must resort to this to get \"get <name>\" as\n            //   the function `name` for proper IDL\n            o = {\n                get [prop] () {\n                    return this['__' + prop];\n                }\n            };\n        }\n\n        const desc = /** @type {PropertyDescriptor} */ (\n            Object.getOwnPropertyDescriptor(o, prop)\n        );\n        // desc.enumerable = true; // Default\n        // desc.configurable = true; // Default\n        Object.defineProperty(obj, prop, desc);\n    });\n}\n\n/**\n *\n * @param {string} item\n * @returns {boolean}\n */\nfunction isIdentifier (item) {\n    // For load-time and run-time performance, we don't provide the complete regular\n    //   expression for identifiers, but these can be passed in, using the expressions\n    //   found at https://gist.github.com/brettz9/b4cd6821d990daa023b2e604de371407\n    // ID_Start (includes Other_ID_Start)\n    const UnicodeIDStart = CFG.UnicodeIDStart || '[$A-Z_a-z]';\n    // ID_Continue (includes Other_ID_Continue)\n    const UnicodeIDContinue = CFG.UnicodeIDContinue || '[$0-9A-Z_a-z]';\n    const IdentifierStart = '(?:' + UnicodeIDStart + '|[$_])';\n    const IdentifierPart = '(?:' + UnicodeIDContinue + '|[$_\\u200C\\u200D])';\n    return (new RegExp('^' + IdentifierStart + IdentifierPart + '*$', 'u')).test(item);\n}\n\n/**\n *\n * @param {string|string[]} keyPathString\n * @returns {boolean}\n */\nfunction isValidKeyPathString (keyPathString) {\n    return typeof keyPathString === 'string' &&\n        (keyPathString === '' || isIdentifier(keyPathString) || keyPathString.split('.').every((pathComponent) => {\n            return isIdentifier(pathComponent);\n        }));\n}\n\n/**\n *\n * @param {string|string[]} keyPath\n * @returns {boolean}\n */\nfunction isValidKeyPath (keyPath) {\n    return isValidKeyPathString(keyPath) || (\n        Array.isArray(keyPath) && Boolean(keyPath.length) &&\n            // Convert array from sparse to dense http://www.2ality.com/2012/06/dense-arrays.html\n            // See also https://heycam.github.io/webidl/#idl-DOMString\n            [...keyPath].every((pathComponent) => {\n                return isValidKeyPathString(pathComponent);\n            })\n    );\n}\n\n/**\n * @param {number} number\n * @param {\"unsigned long long\"|\"unsigned long\"} type\n * @throws {Error|TypeError}\n * @returns {number}\n */\nfunction enforceRange (number, type) {\n    number = Math.floor(Number(number));\n    let max, min;\n    switch (type) {\n    case 'unsigned long long': {\n        max = 0x1FFFFFFFFFFFFF; // 2^53 - 1\n        min = 0;\n        break;\n    }\n    case 'unsigned long': {\n        max = 0xFFFFFFFF; // 2^32 - 1\n        min = 0;\n        break;\n    }\n    default:\n        throw new Error('Unrecognized type supplied to enforceRange');\n    }\n    if (!Number.isFinite(number) ||\n        number > max ||\n        number < min) {\n        throw new TypeError('Invalid range: ' + number);\n    }\n    return number;\n}\n\n/**\n * @typedef {any} AnyValue\n */\n\n/**\n * @param {AnyValue} v\n * @param {boolean} [treatNullAs]\n * @returns {string}\n */\nfunction convertToDOMString (v, treatNullAs) {\n    return v === null && treatNullAs ? '' : ToString(v);\n}\n\n/**\n * @param {AnyValue} o\n * @returns {string}\n */\nfunction ToString (o) { // Todo: See `es-abstract/es7`\n    // `String()` will not throw with Symbols\n    return '' + o; // eslint-disable-line no-implicit-coercion -- Need to throw with symbols\n}\n\n/**\n *\n * @param {AnyValue} val\n * @returns {string|string[]}\n */\nfunction convertToSequenceDOMString (val) {\n    // Per <https://heycam.github.io/webidl/#idl-sequence>, converting to a sequence works with iterables\n    if (isIterable(val)) { // We don't want conversion to array to convert primitives\n        // Per <https://heycam.github.io/webidl/#es-DOMString>, converting to a `DOMString` to be via `ToString`: https://tc39.github.io/ecma262/#sec-tostring\n        return [...val].map((item) => {\n            return ToString(item);\n        });\n    }\n    return ToString(val);\n}\n\n/**\n * @param {AnyValue} v\n * @returns {v is null|undefined}\n */\nfunction isNullish (v) {\n    return v === null || v === undefined;\n}\n\nexport {escapeSQLiteStatement, unescapeSQLiteResponse,\n    escapeDatabaseNameForSQLAndFiles, unescapeDatabaseNameForSQLAndFiles,\n    escapeStoreNameForSQL, escapeIndexNameForSQL, escapeIndexNameForSQLKeyColumn,\n    sqlLIKEEscape, sqlQuote,\n    instanceOf,\n    isObj, isDate, isBlob, isRegExp, isFile, isBinary, isIterable,\n    defineOuterInterface, defineReadonlyOuterInterface,\n    defineListenerProperties, defineReadonlyProperties,\n    isValidKeyPath, enforceRange,\n    convertToDOMString, convertToSequenceDOMString,\n    isNullish};\n","import CFG from './CFG.js';\nimport {encode as keyEncode, decode as keyDecode} from './Key.js';\n\n/**\n * Compares two keys.\n * @param {import('./Key.js').Key} first\n * @param {import('./Key.js').Key} second\n * @returns {0|1|-1}\n */\nfunction cmp (first, second) {\n    const encodedKey1 = /** @type {string} */ (keyEncode(first));\n    const encodedKey2 = /** @type {string} */ (keyEncode(second));\n    const result = encodedKey1 > encodedKey2\n        ? 1\n        : encodedKey1 === encodedKey2 ? 0 : -1;\n\n    if (CFG.DEBUG) {\n        // verify that the keys encoded correctly\n        let decodedKey1 = keyDecode(encodedKey1);\n        let decodedKey2 = keyDecode(encodedKey2);\n        if (typeof first === 'object') {\n            first = JSON.stringify(first);\n            decodedKey1 = JSON.stringify(decodedKey1);\n        }\n        if (typeof second === 'object') {\n            second = JSON.stringify(second);\n            decodedKey2 = JSON.stringify(decodedKey2);\n        }\n\n        // Encoding/decoding mismatches are usually due to a loss of\n        //   floating-point precision\n        if (decodedKey1 !== first) {\n            console.warn(\n                first + ' was incorrectly encoded as ' + decodedKey1\n            );\n        }\n        if (decodedKey2 !== second) {\n            console.warn(\n                second + ' was incorrectly encoded as ' + decodedKey2\n            );\n        }\n    }\n\n    return result;\n}\n\nexport default cmp;\n","import {createDOMException} from './DOMException.js';\nimport * as util from './util.js';\nimport cmp from './cmp.js';\nimport CFG from './CFG.js';\n\n/**\n * @typedef {NodeJS.TypedArray|DataView} ArrayBufferView\n */\n\n/**\n * @typedef {ArrayBufferView|ArrayBuffer} BufferSource\n */\n\n/**\n * @typedef {\"number\"|\"date\"|\"string\"|\"binary\"|\"array\"} KeyType\n */\n\n/**\n * @typedef {any} Value\n */\n\n/**\n * @typedef {any} Key\n * @todo Specify possible value more precisely\n */\n\n/**\n * @typedef {KeyPath[]} KeyPathArray\n */\n/**\n * @typedef {string|KeyPathArray} KeyPath\n */\n\n/**\n* @typedef {object} KeyValueObject\n* @property {KeyType|\"NaN\"|\"null\"|\"undefined\"|\"boolean\"|\"object\"|\"symbol\"|\n*   \"function\"|\"bigint\"} type If not `KeyType`, indicates invalid value\n* @property {Value} [value]\n* @property {boolean} [invalid]\n* @property {string} [message]\n* @todo Specify acceptable `value` more precisely\n*/\n\n/**\n * @typedef {number|string|Date|ArrayBuffer} ValueTypePrimitive\n */\n/**\n * @typedef {ValueType[]} ValueTypeArray\n */\n/**\n * @typedef {ValueTypePrimitive|ValueTypeArray} ValueType\n */\n\n/**\n * Encodes the keys based on their types. This is required to maintain collations\n * We leave space for future keys.\n * @type {{[key: string]: Integer|string}}\n */\nconst keyTypeToEncodedChar = {\n    invalid: 100,\n    number: 200,\n    date: 300,\n    string: 400,\n    binary: 500,\n    array: 600\n};\nconst keyTypes = /** @type {(KeyType|\"invalid\")[]} */ (Object.keys(keyTypeToEncodedChar));\nkeyTypes.forEach((k) => {\n    keyTypeToEncodedChar[k] = String.fromCodePoint(\n        /** @type {number} */ (keyTypeToEncodedChar[k])\n    );\n});\n\nconst encodedCharToKeyType = keyTypes.reduce((o, k) => {\n    o[keyTypeToEncodedChar[k]] = k;\n    return o;\n}, /** @type {{[key: string]: KeyType|\"invalid\"}} */ ({}));\n\n/**\n * The sign values for numbers, ordered from least to greatest.\n *  - \"negativeInfinity\": Sorts below all other values.\n *  - \"bigNegative\": Negative values less than or equal to negative one.\n *  - \"smallNegative\": Negative values between negative one and zero, noninclusive.\n *  - \"smallPositive\": Positive values between zero and one, including zero but not one.\n *  - \"largePositive\": Positive values greater than or equal to one.\n *  - \"positiveInfinity\": Sorts above all other values.\n */\nconst signValues = ['negativeInfinity', 'bigNegative', 'smallNegative', 'smallPositive', 'bigPositive', 'positiveInfinity'];\n\n/**\n * @typedef {any} AnyValue\n */\n\n/**\n * @type {{\n *   [key: string]: {\n *     encode: (param: any, inArray?: boolean) => string,\n *     decode: (param: string, inArray?: boolean) => any\n *   }\n * }}\n */\nconst types = {\n    invalid: {\n        /**\n         * @returns {string}\n         */\n        encode () {\n            return keyTypeToEncodedChar.invalid + '-';\n        },\n        /**\n         * @returns {undefined}\n         */\n        decode () {\n            return undefined;\n        }\n    },\n\n    // Numbers are represented in a lexically sortable base-32 sign-exponent-mantissa\n    // notation.\n    //\n    // sign: takes a value between zero and five, inclusive. Represents infinite cases\n    //     and the signs of both the exponent and the fractional part of the number.\n    // exponent: padded to two base-32 digits, represented by the 32's compliment in the\n    //     \"smallPositive\" and \"bigNegative\" cases to ensure proper lexical sorting.\n    // mantissa: also called the fractional part. Normed 11-digit base-32 representation.\n    //     Represented by the 32's compliment in the \"smallNegative\" and \"bigNegative\"\n    //     cases to ensure proper lexical sorting.\n    number: {\n        // The encode step checks for six numeric cases and generates 14-digit encoded\n        // sign-exponent-mantissa strings.\n        /**\n         * @param {number} key\n         * @returns {string}\n         */\n        encode (key) {\n            let key32 = key === Number.MIN_VALUE\n                // Mocha test `IDBFactory/cmp-spec.js` exposed problem for some\n                //   Node (and Chrome) versions with `Number.MIN_VALUE` being treated\n                //   as 0\n                // https://stackoverflow.com/questions/43305403/number-min-value-and-tostring\n                ? '0.' + '0'.repeat(214) + '2'\n                : Math.abs(key).toString(32);\n            // Get the index of the decimal.\n            const decimalIndex = key32.indexOf('.');\n            // Remove the decimal.\n            key32 = (decimalIndex !== -1) ? key32.replace('.', '') : key32;\n            // Get the index of the first significant digit.\n            const significantDigitIndex = key32.search(/[^0]/u);\n            // Truncate leading zeros.\n            key32 = key32.slice(significantDigitIndex);\n            let sign, exponent, mantissa;\n\n            // Finite cases:\n            if (Number.isFinite(\n                Number(key)\n            )) {\n                // Negative cases:\n                if (key < 0) {\n                    // Negative exponent case:\n                    if (key > -1) {\n                        sign = signValues.indexOf('smallNegative');\n                        exponent = padBase32Exponent(significantDigitIndex);\n                        mantissa = flipBase32(padBase32Mantissa(key32));\n                    // Non-negative exponent case:\n                    } else {\n                        sign = signValues.indexOf('bigNegative');\n                        exponent = flipBase32(padBase32Exponent(\n                            (decimalIndex !== -1) ? decimalIndex : key32.length\n                        ));\n                        mantissa = flipBase32(padBase32Mantissa(key32));\n                    }\n                // Non-negative cases:\n                // Negative exponent case:\n                } else if (key < 1) {\n                    sign = signValues.indexOf('smallPositive');\n                    exponent = flipBase32(padBase32Exponent(significantDigitIndex));\n                    mantissa = padBase32Mantissa(key32);\n                // Non-negative exponent case:\n                } else {\n                    sign = signValues.indexOf('bigPositive');\n                    exponent = padBase32Exponent(\n                        (decimalIndex !== -1) ? decimalIndex : key32.length\n                    );\n                    mantissa = padBase32Mantissa(key32);\n                }\n            // Infinite cases:\n            } else {\n                exponent = zeros(2);\n                mantissa = zeros(11);\n                sign = signValues.indexOf(\n                    key > 0 ? 'positiveInfinity' : 'negativeInfinity'\n                );\n            }\n\n            return keyTypeToEncodedChar.number + '-' + sign + exponent + mantissa;\n        },\n        // The decode step must interpret the sign, reflip values encoded as the 32's complements,\n        // apply signs to the exponent and mantissa, do the base-32 power operation, and return\n        // the original JavaScript number values.\n        /**\n         * @param {string} key\n         * @returns {number}\n         */\n        decode (key) {\n            const sign = Number(key.slice(2, 3));\n            let exponent = key.slice(3, 5);\n            let mantissa = key.slice(5, 16);\n\n            switch (signValues[sign]) {\n            case 'negativeInfinity':\n                return Number.NEGATIVE_INFINITY;\n            case 'positiveInfinity':\n                return Number.POSITIVE_INFINITY;\n            case 'bigPositive':\n                return pow32(mantissa, exponent);\n            case 'smallPositive':\n                exponent = negate(flipBase32(exponent));\n                return pow32(mantissa, exponent);\n            case 'smallNegative':\n                exponent = negate(exponent);\n                mantissa = flipBase32(mantissa);\n                return -pow32(mantissa, exponent);\n            case 'bigNegative':\n                exponent = flipBase32(exponent);\n                mantissa = flipBase32(mantissa);\n                return -pow32(mantissa, exponent);\n            default:\n                throw new Error('Invalid number.');\n            }\n        }\n    },\n\n    // Strings are encoded as JSON strings (with quotes and unicode characters escaped).\n    //\n    // If the strings are in an array, then some extra encoding is done to make sorting work correctly:\n    // Since we can't force all strings to be the same length, we need to ensure that characters line-up properly\n    // for sorting, while also accounting for the extra characters that are added when the array itself is encoded as JSON.\n    // To do this, each character of the string is prepended with a dash (\"-\"), and a space is added to the end of the string.\n    // This effectively doubles the size of every string, but it ensures that when two arrays of strings are compared,\n    // the indexes of each string's characters line up with each other.\n    string: {\n        /**\n         * @param {string} key\n         * @param {boolean} [inArray]\n         * @returns {string}\n         */\n        encode (key, inArray) {\n            if (inArray) {\n                // prepend each character with a dash, and append a space to the end\n                key = key.replaceAll(/(.)/gu, '-$1') + ' ';\n            }\n            return keyTypeToEncodedChar.string + '-' + key;\n        },\n        /**\n         * @param {string} key\n         * @param {boolean} [inArray]\n         * @returns {string}\n         */\n        decode (key, inArray) {\n            key = key.slice(2);\n            if (inArray) {\n                // remove the space at the end, and the dash before each character\n                key = key.slice(0, -1).replaceAll(/-(.)/gu, '$1');\n            }\n            return key;\n        }\n    },\n\n    // Arrays are encoded as JSON strings.\n    // An extra, value is added to each array during encoding to make\n    //  empty arrays sort correctly.\n    array: {\n        /**\n         * @param {ValueTypeArray} key\n         * @returns {string}\n         */\n        encode (key) {\n            const encoded = [];\n            for (const [i, item] of key.entries()) {\n                const encodedItem = encode(item, true); // encode the array item\n                encoded[i] = encodedItem;\n            }\n            encoded.push(keyTypeToEncodedChar.invalid + '-'); // append an extra item, so empty arrays sort correctly\n            return keyTypeToEncodedChar.array + '-' + JSON.stringify(encoded);\n        },\n        /**\n         * @param {string} key\n         * @returns {ValueTypeArray}\n         */\n        decode (key) {\n            const decoded = JSON.parse(key.slice(2));\n            decoded.pop(); // remove the extra item\n            for (let i = 0; i < decoded.length; i++) {\n                const item = decoded[i];\n                const decodedItem = decode(item, true); // decode the item\n                decoded[i] = decodedItem;\n            }\n            return decoded;\n        }\n    },\n\n    // Dates are encoded as ISO 8601 strings, in UTC time zone.\n    date: {\n        /**\n         * @param {Date} key\n         * @returns {string}\n         */\n        encode (key) {\n            return keyTypeToEncodedChar.date + '-' + key.toJSON();\n        },\n        /**\n         * @param {string} key\n         * @returns {Date}\n         */\n        decode (key) {\n            return new Date(key.slice(2));\n        }\n    },\n    binary: {\n        // `ArrayBuffer`/Views on buffers (`TypedArray` or `DataView`)\n        /**\n         * @param {BufferSource} key\n         * @returns {string}\n         */\n        encode (key) {\n            return keyTypeToEncodedChar.binary + '-' + (key.byteLength\n                ? [...getCopyBytesHeldByBufferSource(key)].map(\n                    (b) => String(b).padStart(3, '0')\n                ) // e.g., '255,005,254,000,001,033'\n                : '');\n        },\n        /**\n         * @param {string} key\n         * @returns {ArrayBuffer}\n         */\n        decode (key) {\n            // Set the entries in buffer's [[ArrayBufferData]] to those in `value`\n            const k = key.slice(2);\n            const arr = k.length ? k.split(',').map((s) => Number.parseInt(s)) : [];\n            const buffer = new ArrayBuffer(arr.length);\n            const uint8 = new Uint8Array(buffer);\n            uint8.set(arr);\n            return buffer;\n        }\n    }\n};\n\n/**\n * Return a padded base-32 exponent value.\n * @param {number} n\n * @returns {string}\n */\nfunction padBase32Exponent (n) {\n    const exp = n.toString(32);\n    return (exp.length === 1) ? '0' + exp : exp;\n}\n\n/**\n * Return a padded base-32 mantissa.\n * @param {string} s\n * @returns {string}\n */\nfunction padBase32Mantissa (s) {\n    return (s + zeros(11)).slice(0, 11);\n}\n\n/**\n * Flips each digit of a base-32 encoded string.\n * @param {string} encoded\n * @returns {string}\n */\nfunction flipBase32 (encoded) {\n    let flipped = '';\n    for (const ch of encoded) {\n        flipped += (31 - Number.parseInt(ch, 32)).toString(32);\n    }\n    return flipped;\n}\n\n/**\n * Base-32 power function.\n * RESEARCH: This function does not precisely decode floats because it performs\n * floating point arithmetic to recover values. But can the original values be\n * recovered exactly?\n * Someone may have already figured out a good way to store JavaScript floats as\n * binary strings and convert back. Barring a better method, however, one route\n * may be to generate decimal strings that `parseFloat` decodes predictably.\n * @param {string} mantissa\n * @param {string} exponent\n * @returns {number}\n */\nfunction pow32 (mantissa, exponent) {\n    const exp = Number.parseInt(exponent, 32);\n    if (exp < 0) {\n        return roundToPrecision(\n            Number.parseInt(mantissa, 32) * (32 ** (exp - 10))\n        );\n    }\n    if (exp < 11) {\n        const whole = mantissa.slice(0, exp);\n        const wholeNum = Number.parseInt(whole, 32);\n        const fraction = mantissa.slice(exp);\n        const fractionNum = Number.parseInt(fraction, 32) * (32 ** (exp - 11));\n        return roundToPrecision(wholeNum + fractionNum);\n    }\n    const expansion = mantissa + zeros(exp - 11);\n    return Number.parseInt(expansion, 32);\n}\n\n/**\n * @typedef {number} Float\n */\n\n/**\n * @param {Float} num\n * @param {Float} [precision]\n * @returns {Float}\n */\nfunction roundToPrecision (num, precision = 16) {\n    return Number.parseFloat(num.toPrecision(precision));\n}\n\n/**\n * Returns a string of n zeros.\n * @param {number} n\n * @returns {string}\n */\nfunction zeros (n) {\n    return '0'.repeat(n);\n}\n\n/**\n * Negates numeric strings.\n * @param {string} s\n * @returns {string}\n */\nfunction negate (s) {\n    return '-' + s;\n}\n\n/**\n * @param {Key} key\n * @returns {KeyType|\"invalid\"}\n */\nfunction getKeyType (key) {\n    if (Array.isArray(key)) { return 'array'; }\n    if (util.isDate(key)) { return 'date'; }\n    if (util.isBinary(key)) { return 'binary'; }\n    const keyType = typeof key;\n    return ['string', 'number'].includes(keyType)\n        ? /** @type {\"string\"|\"number\"} */ (keyType)\n        : 'invalid';\n}\n\n/**\n * Keys must be strings, numbers (besides `NaN`), Dates (if value is not\n *   `NaN`), binary objects or Arrays.\n * @param {Value} input The key input\n * @param {Value[]|null|undefined} [seen] An array of already seen keys\n * @returns {KeyValueObject}\n */\nfunction convertValueToKey (input, seen) {\n    return convertValueToKeyValueDecoded(input, seen, false, true);\n}\n\n/**\n* Currently not in use.\n* @param {Value} input\n* @returns {KeyValueObject}\n*/\nfunction convertValueToMultiEntryKey (input) {\n    return convertValueToKeyValueDecoded(input, null, true, true);\n}\n\n/**\n *\n * @param {BufferSource} O\n * @throws {TypeError}\n * @see https://heycam.github.io/webidl/#ref-for-dfn-get-buffer-source-copy-2\n * @returns {Uint8Array}\n */\nfunction getCopyBytesHeldByBufferSource (O) {\n    let offset = 0;\n    let length = 0;\n    if (ArrayBuffer.isView(O)) { // Has [[ViewedArrayBuffer]] internal slot\n        const arrayBuffer = O.buffer;\n        if (arrayBuffer === undefined) {\n            throw new TypeError(\n                'Could not copy the bytes held by a buffer source as the buffer was undefined.'\n            );\n        }\n        offset = O.byteOffset; // [[ByteOffset]] (will also throw as desired if detached)\n        length = O.byteLength; // [[ByteLength]] (will also throw as desired if detached)\n    } else {\n        length = O.byteLength; // [[ArrayBufferByteLength]] on ArrayBuffer (will also throw as desired if detached)\n    }\n    // const octets = new Uint8Array(input);\n    // const octets = types.binary.decode(types.binary.encode(input));\n    return new Uint8Array(\n        // Should allow DataView\n        /** @type {ArrayBuffer} */\n        (('buffer' in O && O.buffer) || O),\n        offset,\n        length\n    );\n}\n\n/**\n* Shortcut utility to avoid returning full keys from `convertValueToKey`\n*   and subsequent need to process in calling code unless `fullKeys` is\n*   set; may throw.\n* @param {Value} input\n* @param {Value[]|null} [seen]\n* @param {boolean} [multiEntry]\n* @param {boolean} [fullKeys]\n* @throws {TypeError} See `getCopyBytesHeldByBufferSource`\n* @todo Document other allowable `input`\n* @returns {KeyValueObject}\n*/\nfunction convertValueToKeyValueDecoded (input, seen, multiEntry, fullKeys) {\n    seen = seen || [];\n    if (seen.includes(input)) {\n        return {\n            type: 'array',\n            invalid: true,\n            message: 'An array key cannot be circular'\n        };\n    }\n    const type = getKeyType(input);\n    const ret = {type, value: input};\n    switch (type) {\n    case 'number': {\n        if (Number.isNaN(input)) {\n            // List as 'NaN' type for convenience of consumers in reporting errors\n            return {type: 'NaN', invalid: true};\n        }\n\n        // https://github.com/w3c/IndexedDB/issues/375\n        // https://github.com/w3c/IndexedDB/pull/386\n        if (Object.is(input, -0)) {\n            return {type, value: 0};\n        }\n        return /** @type {{type: KeyType; value: Value}} */ (ret);\n    } case 'string': {\n        return /** @type {{type: KeyType; value: Value}} */ (ret);\n    } case 'binary': { // May throw (if detached)\n        // Get a copy of the bytes held by the buffer source\n        // https://heycam.github.io/webidl/#ref-for-dfn-get-buffer-source-copy-2\n        const octets = getCopyBytesHeldByBufferSource(\n            /** @type {BufferSource} */ (input)\n        );\n        return {type: 'binary', value: octets};\n    } case 'array': { // May throw (from binary)\n        const arr = /** @type {Array<any>} */ (input);\n        const len = arr.length;\n        seen.push(input);\n\n        /** @type {(KeyValueObject|Value)[]} */\n        const keys = [];\n        for (let i = 0; i < len; i++) { // We cannot iterate here with array extras as we must ensure sparse arrays are invalidated\n            if (!multiEntry && !Object.hasOwn(arr, i)) {\n                return {type, invalid: true, message: 'Does not have own index property'};\n            }\n            try {\n                const entry = arr[i];\n                const key = convertValueToKeyValueDecoded(entry, seen, false, fullKeys); // Though steps do not list rethrowing, the next is returnifabrupt when not multiEntry\n                if (key.invalid) {\n                    if (multiEntry) {\n                        continue;\n                    }\n                    return {type, invalid: true, message: 'Bad array entry value-to-key conversion'};\n                }\n                if (!multiEntry ||\n                    (!fullKeys && keys.every((k) => cmp(k, key.value) !== 0)) ||\n                    (fullKeys && keys.every((k) => cmp(k, key) !== 0))\n                ) {\n                    keys.push(fullKeys ? key : key.value);\n                }\n            } catch (err) {\n                if (!multiEntry) {\n                    throw err;\n                }\n            }\n        }\n        return {type, value: keys};\n    } case 'date': {\n        const date = /** @type {Date} */ (input);\n        if (!Number.isNaN(date.getTime())) {\n            return fullKeys\n                ? {type, value: date.getTime()}\n                : {type, value: new Date(date)};\n        }\n        return {type, invalid: true, message: 'Not a valid date'};\n        // Falls through\n    } case 'invalid': default: {\n        // Other `typeof` types which are not valid keys:\n        //    'undefined', 'boolean', 'object' (including `null`), 'symbol', 'function'\n        const type = input === null ? 'null' : typeof input; // Convert `null` for convenience of consumers in reporting errors\n        return {type, invalid: true, message: 'Not a valid key; type ' + type};\n    }\n    }\n}\n\n/**\n *\n * @param {Key} key\n * @param {boolean} [fullKeys]\n * @returns {KeyValueObject}\n * @todo Document other allowable `key`?\n */\nfunction convertValueToMultiEntryKeyDecoded (key, fullKeys) {\n    return convertValueToKeyValueDecoded(key, null, true, fullKeys);\n}\n\n/**\n* An internal utility.\n* @param {Value} input\n* @param {Value[]|null|undefined} [seen]\n* @throws {DOMException} `DataError`\n* @returns {KeyValueObject}\n*/\nfunction convertValueToKeyRethrowingAndIfInvalid (input, seen) {\n    const key = convertValueToKey(input, seen);\n    if (key.invalid) {\n        throw createDOMException('DataError', key.message || 'Not a valid key; type: ' + key.type);\n    }\n    return key;\n}\n\n/**\n *\n * @param {Value} value\n * @param {KeyPath} keyPath\n * @param {boolean} multiEntry\n * @returns {KeyValueObject|KeyPathEvaluateValue}\n * @todo Document other possible return?\n */\nfunction extractKeyFromValueUsingKeyPath (value, keyPath, multiEntry) {\n    return extractKeyValueDecodedFromValueUsingKeyPath(value, keyPath, multiEntry, true);\n}\n/**\n* Not currently in use.\n* @param {Value} value\n* @param {KeyPath} keyPath\n* @param {boolean} multiEntry\n* @returns {KeyPathEvaluateValue}\n*/\nfunction evaluateKeyPathOnValue (value, keyPath, multiEntry) {\n    return evaluateKeyPathOnValueToDecodedValue(value, keyPath, multiEntry, true);\n}\n\n/**\n* May throw, return `{failure: true}` (e.g., non-object on keyPath resolution)\n*    or `{invalid: true}` (e.g., `NaN`).\n* @param {Value} value\n* @param {KeyPath} keyPath\n* @param {boolean} [multiEntry]\n* @param {boolean} [fullKeys]\n* @returns {KeyValueObject|KeyPathEvaluateValue}\n* @todo Document other possible return?\n*/\nfunction extractKeyValueDecodedFromValueUsingKeyPath (value, keyPath, multiEntry, fullKeys) {\n    const r = evaluateKeyPathOnValueToDecodedValue(value, keyPath, multiEntry, fullKeys);\n    if (r.failure) {\n        return r;\n    }\n    if (!multiEntry) {\n        return convertValueToKeyValueDecoded(r.value, null, false, fullKeys);\n    }\n    return convertValueToMultiEntryKeyDecoded(r.value, fullKeys);\n}\n\n/**\n * Unused?\n * @typedef {object} KeyPathEvaluateFailure\n * @property {boolean} failure\n */\n\n/**\n * @typedef {KeyPathEvaluateValueValue[]} KeyPathEvaluateValueValueArray\n */\n\n/**\n * @typedef {undefined|number|string|Date|object|KeyPathEvaluateValueValueArray} KeyPathEvaluateValueValue\n */\n\n/**\n * @typedef {object} KeyPathEvaluateValue\n * @property {KeyPathEvaluateValueValue} [value]\n * @property {boolean} [failure]\n */\n\n/**\n * Returns the value of an inline key based on a key path (wrapped in an\n *   object with key `value`) or `{failure: true}`\n * @param {Value} value\n * @param {KeyPath} keyPath\n * @param {boolean} [multiEntry]\n * @param {boolean} [fullKeys]\n * @returns {KeyPathEvaluateValue}\n */\nfunction evaluateKeyPathOnValueToDecodedValue (value, keyPath, multiEntry, fullKeys) {\n    if (Array.isArray(keyPath)) {\n        /** @type {KeyPathEvaluateValueValueArray} */\n        const result = [];\n        return keyPath.some((item) => {\n            const key = evaluateKeyPathOnValueToDecodedValue(value, item, multiEntry, fullKeys);\n            if (key.failure) {\n                return true;\n            }\n            result.push(key.value);\n            return false;\n        })\n            ? {failure: true}\n            : {value: result};\n    }\n    if (keyPath === '') {\n        return {value};\n    }\n    const identifiers = keyPath.split('.');\n    return identifiers.some((idntfr) => {\n        if (idntfr === 'length' && (\n            typeof value === 'string' || Array.isArray(value)\n        )) {\n            value = value.length;\n        } else if (util.isBlob(value)) {\n            switch (idntfr) {\n            case 'size': case 'type':\n                value = /** @type {Blob} */ (value)[idntfr];\n                break;\n            default:\n                break;\n            }\n        } else if (util.isFile(value)) {\n            switch (idntfr) {\n            case 'name': case 'lastModified':\n                value = /** @type {File} */ (value)[idntfr];\n                break;\n            case 'lastModifiedDate':\n                value = new Date(/** @type {File} */ (value).lastModified);\n                break;\n            default:\n                break;\n            }\n        } else if (!util.isObj(value) || !Object.hasOwn(value, idntfr)) {\n            return true;\n        } else {\n            value = /** @type {{[key: string]: KeyPathEvaluateValueValue}} */ (\n                value\n            )[idntfr];\n            return value === undefined;\n        }\n        return false;\n    })\n        ? {failure: true}\n        : {value};\n}\n\n/**\n * Sets the inline key value.\n * @param {{[key: string]: AnyValue}} value\n * @param {Key} key\n * @param {string} keyPath\n * @returns {void}\n */\nfunction injectKeyIntoValueUsingKeyPath (value, key, keyPath) {\n    const identifiers = keyPath.split('.');\n    const last = identifiers.pop();\n    identifiers.forEach((identifier) => {\n        const hop = Object.hasOwn(value, identifier);\n        if (!hop) {\n            value[identifier] = {};\n        }\n        value = value[identifier];\n    });\n    value[/** @type {string} */ (last)] = key; // key is already a `keyValue` in our processing so no need to convert\n}\n\n/**\n *\n * @param {Value} value\n * @param {string} keyPath\n * @see https://github.com/w3c/IndexedDB/pull/146\n * @returns {boolean}\n */\nfunction checkKeyCouldBeInjectedIntoValue (value, keyPath) {\n    const identifiers = keyPath.split('.');\n    identifiers.pop();\n    for (const identifier of identifiers) {\n        if (!util.isObj(value)) {\n            return false;\n        }\n        const hop = Object.hasOwn(value, identifier);\n        if (!hop) {\n            return true;\n        }\n        value = /** @type {{[key: string]: Value}} */ (value)[identifier];\n    }\n    return util.isObj(value);\n}\n\n/**\n *\n * @param {Key} key\n * @param {import('./IDBKeyRange.js').IDBKeyRangeFull} range\n * @param {boolean} [checkCached]\n * @returns {boolean}\n */\nfunction isKeyInRange (key, range, checkCached) {\n    let lowerMatch = range.lower === undefined;\n    let upperMatch = range.upper === undefined;\n    const encodedKey = encode(key, true);\n    const lower = checkCached ? range.__lowerCached : encode(range.lower, true);\n    const upper = checkCached ? range.__upperCached : encode(range.upper, true);\n\n    if (!lowerMatch && (\n        (range.lowerOpen &&\n            encodedKey !== null && lower !== null && encodedKey > lower) ||\n        (!range.lowerOpen && (\n            (!encodedKey && !lower) ||\n            (encodedKey !== null && lower !== null && encodedKey >= lower))\n        )\n    )) {\n        lowerMatch = true;\n    }\n    if (!upperMatch && (\n        (range.upperOpen &&\n            encodedKey !== null && upper !== null && encodedKey < upper) ||\n        (!range.upperOpen && (\n            (!encodedKey && !upper) ||\n            (encodedKey !== null && upper !== null && encodedKey <= upper))\n        )\n    )) {\n        upperMatch = true;\n    }\n\n    return lowerMatch && upperMatch;\n}\n\n/**\n * Determines whether an index entry matches a multi-entry key value.\n * @param {string} encodedEntry     The entry value (already encoded)\n * @param {string} encodedKey       The full index key (already encoded)\n * @returns {boolean}\n */\nfunction isMultiEntryMatch (encodedEntry, encodedKey) {\n    const keyType = encodedCharToKeyType[encodedKey.slice(0, 1)];\n\n    if (keyType === 'array') {\n        return encodedKey.indexOf(encodedEntry) > 1;\n    }\n    return encodedKey === encodedEntry;\n}\n\n/**\n *\n * @param {Key} keyEntry\n * @param {import('./IDBKeyRange.js').IDBKeyRangeFull|undefined} range\n * @returns {Key[]}\n */\nfunction findMultiEntryMatches (keyEntry, range) {\n    const matches = [];\n\n    if (Array.isArray(keyEntry)) {\n        for (let key of keyEntry) {\n            if (Array.isArray(key)) {\n                if (range && range.lower === range.upper) {\n                    continue;\n                }\n                if (key.length === 1) {\n                    // eslint-disable-next-line sonarjs/updated-loop-counter -- Convenient\n                    key = key[0];\n                } else {\n                    const nested = findMultiEntryMatches(key, range);\n                    if (nested.length > 0) {\n                        matches.push(key);\n                    }\n                    continue;\n                }\n            }\n\n            if (util.isNullish(range) || isKeyInRange(key, range, true)) {\n                matches.push(key);\n            }\n        }\n    } else if (util.isNullish(range) || isKeyInRange(keyEntry, range, true)) {\n        matches.push(keyEntry);\n    }\n    return matches;\n}\n\n/**\n* Not currently in use but keeping for spec parity.\n* @param {Key} key\n* @throws {Error} Upon a \"bad key\"\n* @returns {ValueType}\n*/\nfunction convertKeyToValue (key) {\n    const {type, value} = key;\n    switch (type) {\n    case 'number': case 'string': {\n        return value;\n    } case 'array': {\n        const array = [];\n        const len = value.length;\n        let index = 0;\n        while (index < len) {\n            const entry = convertKeyToValue(value[index]);\n            array[index] = entry;\n            index++;\n        }\n        return array;\n    } case 'date': {\n        return new Date(value);\n    } case 'binary': {\n        const len = value.length;\n        const buffer = new ArrayBuffer(len);\n        // Set the entries in buffer's [[ArrayBufferData]] to those in `value`\n        const uint8 = new Uint8Array(buffer, value.byteOffset || 0, value.byteLength);\n        uint8.set(value);\n        return buffer;\n    } case 'invalid': default:\n        throw new Error('Bad key');\n    }\n}\n\n/**\n *\n * @param {Key} key\n * @param {boolean} [inArray]\n * @returns {string|null}\n */\nfunction encode (key, inArray) {\n    // Bad keys like `null`, `object`, `boolean`, 'function', 'symbol' should not be passed here due to prior validation\n    if (key === undefined) {\n        return null;\n    }\n    // array, date, number, string, binary (should already have detected \"invalid\")\n    return types[getKeyType(key)].encode(key, inArray);\n}\n\n/**\n *\n * @param {Key} key\n * @param {boolean} [inArray]\n * @throws {Error} Invalid number\n * @returns {undefined|ValueType}\n */\nfunction decode (key, inArray) {\n    if (typeof key !== 'string') {\n        return undefined;\n    }\n    return types[encodedCharToKeyType[key.slice(0, 1)]].decode(key, inArray);\n}\n\n/**\n *\n * @param {Key} key\n * @param {boolean} [inArray]\n * @returns {undefined|ValueType}\n */\nfunction roundTrip (key, inArray) {\n    return decode(encode(key, inArray), inArray);\n}\n\nconst MAX_ALLOWED_CURRENT_NUMBER = 9007199254740992; // 2 ^ 53 (Also equal to `Number.MAX_SAFE_INTEGER + 1`)\n\n/**\n * @typedef {number} Integer\n */\n\n/**\n * @callback CurrentNumberCallback\n * @param {Integer} cn The current number\n * @returns {void}\n */\n\n/**\n* @callback SQLFailureCallback\n* @param {DOMException|Error} exception\n* @returns {void}\n*/\n\n/**\n *\n * @param {SQLTransaction} tx\n * @param {import('./IDBObjectStore.js').IDBObjectStoreFull} store\n * @param {CurrentNumberCallback} func\n * @param {SQLFailureCallback} sqlFailCb\n * @returns {void}\n */\nfunction getCurrentNumber (tx, store, func, sqlFailCb) {\n    tx.executeSql('SELECT \"currNum\" FROM __sys__ WHERE \"name\" = ?', [\n        util.escapeSQLiteStatement(store.__currentName)\n    ], function (tx, data) {\n        if (data.rows.length !== 1) {\n            func(1);\n        } else {\n            func(data.rows.item(0).currNum);\n        }\n    }, function (tx, error) {\n        sqlFailCb(createDOMException(\n            'DataError',\n            'Could not get the auto increment value for key',\n            error\n        ));\n        return false;\n    });\n}\n\n/**\n *\n * @param {SQLTransaction} tx\n * @param {import('./IDBObjectStore.js').IDBObjectStoreFull} store\n * @param {Integer} num\n * @param {CurrentNumberCallback} successCb\n * @param {SQLFailureCallback} failCb\n * @returns {void}\n */\nfunction assignCurrentNumber (tx, store, num, successCb, failCb) {\n    const sql = 'UPDATE __sys__ SET \"currNum\" = ? WHERE \"name\" = ?';\n    const sqlValues = [num, util.escapeSQLiteStatement(store.__currentName)];\n    if (CFG.DEBUG) { console.log(sql, sqlValues); }\n    tx.executeSql(sql, sqlValues, function () {\n        successCb(num);\n    }, function (tx, err) {\n        failCb(createDOMException('UnknownError', 'Could not set the auto increment value for key', err));\n        return false;\n    });\n}\n\n/**\n * Bump up the auto-inc counter if the key path-resolved value is valid\n *   (greater than old value and >=1) OR if a manually passed in key is\n *   valid (numeric and >= 1) and >= any primaryKey.\n * @param {SQLTransaction} tx\n * @param {import('./IDBObjectStore.js').IDBObjectStoreFull} store\n * @param {Integer} num\n * @param {CurrentNumberCallback} successCb\n * @param {SQLFailureCallback} failCb\n * @returns {void}\n */\nfunction setCurrentNumber (tx, store, num, successCb, failCb) {\n    num = num === MAX_ALLOWED_CURRENT_NUMBER\n        ? num + 2 // Since incrementing by one will have no effect in JavaScript on this unsafe max, we represent the max as a number incremented by two. The getting of the current number is never returned to the user and is only used in safe comparisons, so it is safe for us to represent it in this manner\n        : num + 1;\n    return assignCurrentNumber(tx, store, num, successCb, failCb);\n}\n\n/**\n * @callback KeyForStoreCallback\n * @param {\"failure\"|null} arg1\n * @param {Integer} [arg2]\n * @param {Integer} [arg3]\n * @returns {void}\n */\n\n/**\n *\n * @param {SQLTransaction} tx\n * @param {import('./IDBObjectStore.js').IDBObjectStoreFull} store\n * @param {KeyForStoreCallback} cb\n * @param {SQLFailureCallback} sqlFailCb\n * @returns {void}\n */\nfunction generateKeyForStore (tx, store, cb, sqlFailCb) {\n    getCurrentNumber(tx, store, function (key) {\n        if (key > MAX_ALLOWED_CURRENT_NUMBER) { // 2 ^ 53 (See <https://github.com/w3c/IndexedDB/issues/147>)\n            cb('failure');\n            return;\n        }\n        // Increment current number by 1 (we cannot leverage SQLite's\n        //  autoincrement (and decrement when not needed), as decrementing\n        //  will be overwritten/ignored upon the next insert)\n        setCurrentNumber(\n            tx, store, key,\n            function () {\n                cb(null, key, key);\n            },\n            sqlFailCb\n        );\n    }, sqlFailCb);\n}\n\n// Fractional or numbers exceeding the max do not get changed in the result\n//     per https://github.com/w3c/IndexedDB/issues/147\n//     so we do not return a key\n/**\n *\n * @param {SQLTransaction} tx\n * @param {import('./IDBObjectStore.js').IDBObjectStoreFull} store\n * @param {Key} key\n * @param {(num?: Integer) => void} successCb\n * @param {SQLFailureCallback} sqlFailCb\n * @returns {void}\n */\nfunction possiblyUpdateKeyGenerator (tx, store, key, successCb, sqlFailCb) {\n    // Per https://github.com/w3c/IndexedDB/issues/147 , non-finite numbers\n    //   (or numbers larger than the max) are now to have the explicit effect of\n    //   setting the current number (up to the max), so we do not optimize them\n    //   out here\n    if (typeof key !== 'number' || key < 1) { // Optimize with no need to get the current number\n        // Auto-increment attempted with a bad key;\n        //   we are not to change the current number, but the steps don't call for failure\n        // Numbers < 1 are optimized out as they will never be greater than the current number which must be at least 1\n        successCb();\n    } else {\n        // If auto-increment and the keyPath item is a valid numeric key, get the old auto-increment to compare if the new is higher\n        //  to determine which to use and whether to update the current number\n        getCurrentNumber(tx, store, function (cn) {\n            const value = Math.floor(\n                Math.min(key, MAX_ALLOWED_CURRENT_NUMBER)\n            );\n            const useNewKeyForAutoInc = value >= cn;\n            if (useNewKeyForAutoInc) {\n                setCurrentNumber(tx, store, value, function () {\n                    successCb(cn); // Supply old current number in case needs to be reverted\n                }, sqlFailCb);\n            } else { // Not updated\n                successCb();\n            }\n        }, sqlFailCb);\n    }\n}\n\nexport {encode, decode, roundTrip, convertKeyToValue, convertValueToKeyValueDecoded,\n    convertValueToMultiEntryKeyDecoded,\n    convertValueToKey,\n    convertValueToMultiEntryKey, convertValueToKeyRethrowingAndIfInvalid,\n    extractKeyFromValueUsingKeyPath, evaluateKeyPathOnValue,\n    extractKeyValueDecodedFromValueUsingKeyPath, injectKeyIntoValueUsingKeyPath, checkKeyCouldBeInjectedIntoValue,\n    isMultiEntryMatch, isKeyInRange, findMultiEntryMatches,\n    assignCurrentNumber,\n    generateKeyForStore, possiblyUpdateKeyGenerator};\n"],"names":["map","CFG","createNativeDOMException","name","message","DOMException","prototype","constructor","val","test","TypeError","forEach","prop","validator","Array","isArray","Object","defineProperty","get","set","codes","IndexSizeError","HierarchyRequestError","WrongDocumentError","InvalidCharacterError","NoModificationAllowedError","NotFoundError","NotSupportedError","InUseAttributeError","InvalidStateError","SyntaxError","InvalidModificationError","NamespaceError","InvalidAccessError","TypeMismatchError","SecurityError","NetworkError","AbortError","URLMismatchError","QuotaExceededError","TimeoutError","InvalidNodeTypeError","DataCloneError","EncodingError","NotReadableError","UnknownError","ConstraintError","DataError","TransactionInactiveError","ReadOnlyError","VersionError","OperationError","NotAllowedError","legacyCodes","INDEX_SIZE_ERR","DOMSTRING_SIZE_ERR","HIERARCHY_REQUEST_ERR","WRONG_DOCUMENT_ERR","INVALID_CHARACTER_ERR","NO_DATA_ALLOWED_ERR","NO_MODIFICATION_ALLOWED_ERR","NOT_FOUND_ERR","NOT_SUPPORTED_ERR","INUSE_ATTRIBUTE_ERR","INVALID_STATE_ERR","SYNTAX_ERR","INVALID_MODIFICATION_ERR","NAMESPACE_ERR","INVALID_ACCESS_ERR","VALIDATION_ERR","TYPE_MISMATCH_ERR","SECURITY_ERR","NETWORK_ERR","ABORT_ERR","URL_MISMATCH_ERR","QUOTA_EXCEEDED_ERR","TIMEOUT_ERR","INVALID_NODE_TYPE_ERR","DATA_CLONE_ERR","ShimNonNativeDOMException","this","Symbol","toStringTag","_code","_name","_message","undefined","configurable","enumerable","writable","value","DummyDOMException","create","Error","keys","codeName","createNonNativeDOMExceptionClass","logError","error","DEBUG","msg","method","console","trace","useNativeDOMException","obj","err","createDOMException","createNonNativeDOMException","escapeSQLiteStatement","arg","replaceAll","_","unmatchedHighSurrogate","precedingLow","unmatchedLowSurrogate","codePointAt","toString","padStart","escapeUnmatchedSurrogates","isObj","isNullish","v","cmp","first","second","encodedKey1","keyEncode","encodedKey2","result","decodedKey1","keyDecode","decodedKey2","JSON","stringify","warn","keyTypeToEncodedChar","invalid","number","date","string","binary","array","keyTypes","k","String","fromCodePoint","encodedCharToKeyType","reduce","o","signValues","types","encode","decode","key","key32","Number","MIN_VALUE","repeat","Math","abs","decimalIndex","indexOf","replace","significantDigitIndex","search","sign","exponent","mantissa","slice","isFinite","padBase32Exponent","flipBase32","padBase32Mantissa","length","zeros","NEGATIVE_INFINITY","POSITIVE_INFINITY","pow32","negate","inArray","encoded","i","item","entries","encodedItem","push","decoded","parse","pop","decodedItem","toJSON","Date","byteLength","getCopyBytesHeldByBufferSource","b","arr","split","s","parseInt","buffer","ArrayBuffer","Uint8Array","n","exp","flipped","ch","roundToPrecision","whole","wholeNum","fraction","expansion","num","precision","parseFloat","toPrecision","getKeyType","getDate","util","getFloat64","keyType","includes","convertValueToKey","input","seen","convertValueToKeyValueDecoded","O","offset","isView","byteOffset","multiEntry","fullKeys","type","ret","isNaN","is","len","hasOwn","every","getTime","convertValueToMultiEntryKeyDecoded","extractKeyValueDecodedFromValueUsingKeyPath","keyPath","r","evaluateKeyPathOnValueToDecodedValue","failure","some","idntfr","size","lastModified","isKeyInRange","range","checkCached","lowerMatch","lower","upperMatch","upper","encodedKey","__lowerCached","__upperCached","lowerOpen","upperOpen","MAX_ALLOWED_CURRENT_NUMBER","getCurrentNumber","tx","store","func","sqlFailCb","executeSql","__currentName","data","rows","currNum","assignCurrentNumber","successCb","failCb","sql","sqlValues","log","setCurrentNumber","identifiers","identifier","convertKeyToValue","index","entry","findMultiEntryMatches","keyEntry","matches","cb","last","encodedEntry","cn","floor","min"],"mappings":"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"}